#!/bin/bash

echo "üöÄ VX School - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π"
echo "=================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js..."
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –≤–µ—Ä—Å–∏–∏ 18+"
    exit 1
fi

NODE_VERSION=$(node --version)
echo "‚úÖ Node.js –≤–µ—Ä—Å–∏—è: $NODE_VERSION"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ npm
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "‚úÖ npm –Ω–∞–π–¥–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

if [ $? -eq 0 ]; then
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üìã –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª –∏–∑ .env.example"
    exit 1
fi

echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ data –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "data" ]; then
    mkdir -p data
    echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ data"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
if command -v node &> /dev/null; then
    node security-check.js
fi

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
timeout 10s npm start &
SERVER_PID=$!

sleep 5

if ps -p $SERVER_PID > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ"
    kill $SERVER_PID 2>/dev/null
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "=================================="
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: npm start"
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç: https://vxschool.ru"
echo "3. –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å: https://vxschool.ru/admin/"
echo ""
echo "üîê –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É:"
echo "–õ–æ–≥–∏–Ω: vxschool_admin"
echo "–ü–∞—Ä–æ–ª—å: VXMusic2024!Secure#Admin"
echo ""
echo "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: ADMIN.md"